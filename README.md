# OpenWrt Firmware Builder

This is a build-system for OpenWrt based Firmwares. The Code is the core used for the Firmware of Freifunk Berlin.
The build-system consists of some scripts to easily manage the creation of different types of firmware images
for different target-architectures. It is based on vanilla [OpenWrt](https://openwrt.org/start) but can use 
patches also to modify or fix individual aspects of OpenWrt.

## Contact / More information

As this software has its roots in the Freifunk Community of Berlin, they are the best ressource to contact.

For questions write a mail to <berlin@berlin.freifunk.net> or come to our weekly meetings.
If you find bugs please report them at: https://github.com/freifunk-berlin/firmware/issues

## Development

### Info

The build-system uses vanilla OpenWrt with optional additional patches and a custom list of feeds. The Makefile 
automates firmware creation and applies the patches. All custom patches are located in *patches/*.

### Build Prerequisites

Please take a look at the [OpenWrt documentation](https://openwrt.org/docs/guide-developer/build-system/install-buildsystem?s[]=prerequisites#prerequisites)
for a complete and uptodate list of packages for your operating system. 

On Ubuntu/Debian:
```
apt-get install git build-essential libncurses5-dev zlib1g-dev gawk time \
  unzip libxml-perl flex wget gawk gettext quilt python libssl-dev
```

On openSUSE:
```
zypper install --type pattern devel_basis
zypper install git ncurses-devel zlib-devel gawk time \
  unzip perl-libxml-perl flex wget gawk gettext-runtime quilt python libopenssl-devel
```
On Arch/Antergos:
```
pacman -S base-devel git ncurses lib32-zlib gawk time unzip perl-xml-libxml \
 flex wget gettext quilt python2 openssl
```

### Building all firmwares

To get the source and build the firmware locally use:

```
git clone https://github.com/freifunk-berlin/firmware.git
cd firmware
make
```

The build will take some time. You can improve the build time with [build options](https://openwrt.org/docs/guide-developer/build-system/use-buildsystem)
such as `-j <number of cores>`. `V=s` will give more verbose error messages.

An internet connection is required during the build process. A good internet
connection can improve the build time.

You need approximately 10GB of space for the build.

### Building individual packages

To develop on a single package or to compile a special package, which is not available by default
on OpenWrt or Freifunk-Berlin, you can use the SDK. The prebuilt SDK of the firmware you are 
running on can be found in the TARGETS root-folder.

To build your own package with the SDK do the following:

```
(cd /tmp; wget https://firmware.berlin...SDK*.tar.xz)
git clone https://github.com/freifunk-berlin/firmware.git
cd firmware
make setup-sdk SDK_FILE=/tmp/<SDK-file from above>
cd sdk-<target>
```

This folder represents the environment, that was used during building the firmware, including all
patches. You can customize the environment, install feeds and packages and update the existing
code.
To build a single package use the normal OpwnWrt command:

```
make package/freifunk-berlin-ffwizard/compile
```

### Directory Layout

You can find the actual firmware images generated by the ImageBuilder (and the ImageBuilder itself)
in `firmwares`. The layout looks like the following:

```
firmwares/
    TARGET/
        backbone/
           images..
        default/
           images..
        ...
        OpenWrt-ImageBuilder-....tar.xz
        OpenWrt-SDK-....tar.xz
        initrd/
           images..
        packages/
           packages/<ARCH>
              base/*.ipk
              luci/*.ipk
              packages/*.ipk
              packages_berlin/*.ipk
              routing/*.ipk
           targets/MAINTARGET/SUBTARGET/packages/
              *.ipk
```

As you notice there are several different image variants ("backbone", "default", etc.).
These different *packages lists* are defined in `packages/`.
See the "Features" section above for a description of the purpose of each package list.
With the "OpenWrt-Imagebuilder" you can assemble your own image variant with your
*packages lists* without having to compile everything yourself. The "OpenWrt-SDK" is
the fastest way to build your own packages or programs without compiling OpenWrt itself.
The "initrd" directory contains some initrd-images for netboot, which are required on
some boards to initially install OpenWrt.

### customizing make

`make` will use by default `TARGET` and `PACKAGES_LIST_DEFAULT` defined in
`config.mk`. You can customize this by overriding them:

```
make TARGET=mpc85xx PACKAGES_LIST_DEFAULT=backbone
```
in addition you can build your own image from a prebuilt imagebuilder by something like:

```
make images IB_FILE=<file> TARGET=... PACKAGES_LIST_DEFAULT=...
```

The default target is `ar71xx-generic`. For a complete list of supported targets look in `configs/` for the target-specific configs.
Each of these targets need a matching file in `profiles/` with the profiles (boards) that should be build with the imagebuilder.

additional options

* IS_BUILDBOT :
  * this will be "yes" when running on the buildbot farm and helps to save some disc-space by removing files not required anymore. On manual builds you should not set this to "yes", as you have to rebuild the whole toolchain each time.
* SET_BUILDBOT :
  * "env" the Makefile will honor the "IS_BUILDBOT" environment
  * "yes" the Makefile will always act as "IS_BUILDBOT" was set to "yes"
  * "no"  the Makefile will always act as "IS_BUILDBOT" was set to "no" / is unset. This way we can run builds on the buildbot like a local build.

### Patches with "git format-patch"

**Important:** all patches should be pushed upstream!

If a patch is not yet included upstream, it can be placed in the corresponding subdirectory below the`patches`
directory. To create a correct patch-file just use the [`git format-patch`](https://git-scm.com/docs/git-format-patch) command.

#### Create a patch

In order to add a patch file update your build environment by running:

```bash
make clean patch
```
Then switch to the openwrt directory:

```bash
cd openwrt
```

or continue to the relevant feed directory:

```bash
cd feeds/luci
```

use the normal `git commit` workflow to apply your changes to the code. When done convert your last commit 
into a patch by running:

```bash
git format-patch --start-number <n> HEAD^
```
where `n` is the next free number of the correlating patch-subdirectory. You can use something like `HEAD^^^^`
to create patch-files from you last 4 commmits, or even use a git-rev directly. Feel free to squash multiple 
commits into a single one before creating the patch-file or use something like 

```bash
git format-patch --stdout HEAD^^^^ > patches/routing/0008-awesome.patch
```
to create a single file of these 4 commits

#### Modify a patch

To update an existing patch do the same as above:

```bash
make clean patch
cd openwrt
cd feeds/luci
```
Then just add a new commit with your changes and squash it with the commit relating to the patch-file.
To update the patch-file use the same `git format-patch` sequence as you did when creating the patch
initially.

#### Delete a patch

To remove a patch-file you have to remove it from the patch-subdirectory and update the build-
environment:

```bash
git rm patches/openwrt/0010-unrelevant-change.patch
make patch
```

### Submitting patches

#### Freifunk Berlin

Please create a pull request for the project you want to submit a patch.
If you are already member of the Freifunk Berlin team, please delete branches once they have been merged.

#### OpenWrt

Create a commit in the openwrt directory that contains your change. Use `git
format-patch` to create a patch:

```
git format-patch origin
```

Send a patch to the OpenWrt mailing list with `git send-email`:

```
git send-email \
  --to=openwrt-devel@lists.openwrt.org \
  --smtp-server=mail.foo.bar \
  --smtp-user=foo \
  --smtp-encryption=tls \
  0001-a-fancy-change.patch
```

Additional information: https://dev.openwrt.org/wiki/SubmittingPatches
