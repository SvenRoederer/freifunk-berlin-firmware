From: Sven Roederer <devel-sven@geroedel.de>
Date: Wed, 21 Apr 2021 08:33:27 +0200
Subject: build: remove NPROC_MAX; allow externally overwriting NPROC

diff --git a/config/Config-devel.in b/config/Config-devel.in
index 11ddc85b6e5b4721e9d0efcf6458dd72704f248f..126462bfc3a0a12324b3ac38614c4f94638d0115 100644
--- a/config/Config-devel.in
+++ b/config/Config-devel.in
@@ -45,15 +45,6 @@ menuconfig DEVEL
 		  This allows you to symlink build_dir into a scratch location, e.g. a ramdisk,
 		  which does not have enough space to keep a complete build_dir.
 
-	config NPROC_MAX
-		int "max CPUs to be used" if DEVEL
-		default 0
-		help
-		   Forces to use this many CPU in parallel at max.
-		   A value of 0 uses autodetection for max available CPUs. All other values
-		   definie the upper limit.
-		   This is currently relevant for the compression of the imagebuilder and sdk.
-
 	config BUILD_SUFFIX
 		string "Build suffix to append to the target BUILD_DIR variable" if DEVEL
 		default ""
diff --git a/rules.mk b/rules.mk
index f31d9bb113e25f83475177ca83125d98ba9346a6..15327f98eef02bdf775ee3814305c8f64a52de1b 100644
--- a/rules.mk
+++ b/rules.mk
@@ -67,7 +67,7 @@ TARGET_SUFFIX=$(call qstrip,$(CONFIG_TARGET_SUFFIX))
 BUILD_SUFFIX:=$(call qstrip,$(CONFIG_BUILD_SUFFIX))
 SUBDIR:=$(patsubst $(TOPDIR)/%,%,${CURDIR})
 BUILD_SUBDIR:=$(patsubst $(TOPDIR)/%,%,${CURDIR})
-NPROC:=$(shell sysctl -n hw.ncpu 2>/dev/null || nproc)
+NPROC?=$(shell sysctl -n hw.ncpu 2>/dev/null || nproc)
 export SHELL:=/usr/bin/env bash
 
 IS_PACKAGE_BUILD := $(if $(filter package/%,$(BUILD_SUBDIR)),1)
diff --git a/target/imagebuilder/Makefile b/target/imagebuilder/Makefile
index ef1b7007bee0466f55bb1a6834d80f5669c5241d..ef7fd3f25e856c4173f78ace45a98090f61a0779 100644
--- a/target/imagebuilder/Makefile
+++ b/target/imagebuilder/Makefile
@@ -107,7 +107,7 @@ endif
 	$(CP) $(TOPDIR)/staging_dir/host/lib/libfakeroot* $(PKG_BUILD_DIR)/staging_dir/host/lib
 	STRIP=$(STAGING_DIR_HOST)/bin/sstrip $(SCRIPT_DIR)/rstrip.sh $(PKG_BUILD_DIR)/staging_dir/host/bin/
 	(cd $(BUILD_DIR); \
-		tar -I '$(STAGING_DIR_HOST)/bin/xz -7e -T$(if $(CONFIG_NPROC_MAX),$(CONFIG_NPROC_MAX),$(if $(filter 1,$(NPROC)),2,0))' -cf $@ $(IB_NAME) \
+		tar -I '$(STAGING_DIR_HOST)/bin/xz -7e -T$(if $(filter 1,$(NPROC)),2,0)' -cf $@ $(IB_NAME) \
 		--mtime="$(shell date --date=@$(SOURCE_DATE_EPOCH))"; \
 	)
 
diff --git a/target/sdk/Makefile b/target/sdk/Makefile
index aba1f336f1ec6bbbd37c00058340ed6d2a1231b2..5330d1495543bdfdb4286d01e7ea7300ce9239dc 100644
--- a/target/sdk/Makefile
+++ b/target/sdk/Makefile
@@ -165,7 +165,7 @@ $(BIN_DIR)/$(SDK_NAME).tar.xz: clean
 	find $(SDK_BUILD_DIR) -name CVS | $(XARGS) rm -rf
 	-make -C $(SDK_BUILD_DIR)/scripts/config clean
 	(cd $(BUILD_DIR); \
-		tar -I '$(STAGING_DIR_HOST)/bin/xz -7e -T$(if $(CONFIG_NPROC_MAX),$(CONFIG_NPROC_MAX),$(if $(filter 1,$(NPROC)),2,0))' -cf $@ $(SDK_NAME) \
+		tar -I '$(STAGING_DIR_HOST)/bin/xz -7e -T$(if $(filter 1,$(NPROC)),2,0)' -cf $@ $(SDK_NAME) \
 		--mtime="$(shell date --date=@$(SOURCE_DATE_EPOCH))"; \
 	)
 
