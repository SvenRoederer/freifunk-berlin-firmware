From: Sven Roederer <devel-sven@geroedel.de>
Date: Wed, 19 May 2021 01:12:06 +0200
Subject: libopkg: pkg_hash: print unresolved dependencies

use patch from https://patchwork.ozlabs.org/project/openwrt/patch/20210502205912.23753-1-hauke@hauke-m.de/
to locally fix the "unmet-dependency error" of FS#3814

diff --git a/package/system/opkg/Makefile b/package/system/opkg/Makefile
index fb7d8667c66e6d0ed9e63bba7a262828ba7e169d..25cb04fec533a879c6addbe75e48a120c907884c 100644
--- a/package/system/opkg/Makefile
+++ b/package/system/opkg/Makefile
@@ -9,7 +9,7 @@ include $(TOPDIR)/rules.mk
 include $(INCLUDE_DIR)/kernel.mk
 
 PKG_NAME:=opkg
-PKG_RELEASE:=1
+PKG_RELEASE:=1.local
 PKG_FLAGS:=essential
 
 PKG_SOURCE_PROTO:=git
diff --git a/package/system/opkg/patches/opkg-libopkg-pkg_hash-print-unresolved-dependencies.patch b/package/system/opkg/patches/opkg-libopkg-pkg_hash-print-unresolved-dependencies.patch
new file mode 100644
index 0000000000000000000000000000000000000000..45dfb415565cdb04b14ef4c9cff687e6d07078dc
--- /dev/null
+++ b/package/system/opkg/patches/opkg-libopkg-pkg_hash-print-unresolved-dependencies.patch
@@ -0,0 +1,165 @@
+From patchwork Sun May  2 20:59:12 2021
+Content-Type: text/plain; charset="utf-8"
+MIME-Version: 1.0
+Content-Transfer-Encoding: 7bit
+X-Patchwork-Submitter: Hauke Mehrtens <hauke@hauke-m.de>
+X-Patchwork-Id: 1472886
+X-Patchwork-Delegate: hauke@hauke-m.de
+Return-Path: 
+ <openwrt-devel-bounces+incoming=patchwork.ozlabs.org@lists.openwrt.org>
+X-Original-To: incoming@patchwork.ozlabs.org
+Delivered-To: patchwork-incoming@bilbo.ozlabs.org
+Authentication-Results: ozlabs.org;
+ spf=none (no SPF record) smtp.mailfrom=lists.openwrt.org
+ (client-ip=2001:8b0:10b:1:d65d:64ff:fe57:4e05; helo=desiato.infradead.org;
+ envelope-from=openwrt-devel-bounces+incoming=patchwork.ozlabs.org@lists.openwrt.org;
+ receiver=<UNKNOWN>)
+Authentication-Results: ozlabs.org;
+	dkim=pass (2048-bit key;
+ secure) header.d=lists.infradead.org header.i=@lists.infradead.org
+ header.a=rsa-sha256 header.s=desiato.20200630 header.b=Pk0NAK3j;
+	dkim=fail reason="signature verification failed" (2048-bit key;
+ unprotected) header.d=hauke-m.de header.i=@hauke-m.de header.a=rsa-sha256
+ header.s=MBO0001 header.b=mt3MDyel;
+	dkim-atps=neutral
+Received: from desiato.infradead.org (desiato.infradead.org
+ [IPv6:2001:8b0:10b:1:d65d:64ff:fe57:4e05])
+	(using TLSv1.3 with cipher TLS_AES_256_GCM_SHA384 (256/256 bits)
+	 key-exchange X25519 server-signature RSA-PSS (4096 bits) server-digest
+ SHA256)
+	(No client certificate requested)
+	by ozlabs.org (Postfix) with ESMTPS id 4FYJRY5lcMz9s1l
+	for <incoming@patchwork.ozlabs.org>; Mon,  3 May 2021 07:00:57 +1000 (AEST)
+DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=relaxed/relaxed;
+	d=lists.infradead.org; s=desiato.20200630; h=Sender:Content-Transfer-Encoding
+	:Content-Type:List-Subscribe:List-Help:List-Post:List-Archive:
+	List-Unsubscribe:List-Id:MIME-Version:Message-Id:Date:Subject:Cc:To:From:
+	Reply-To:Content-ID:Content-Description:Resent-Date:Resent-From:Resent-Sender
+	:Resent-To:Resent-Cc:Resent-Message-ID:In-Reply-To:References:List-Owner;
+	bh=WUlfVnLANnRR7FuVFnyiwrbbTtQe3dU/OCWEJAGaVho=; b=Pk0NAK3j80rp0BatwNKycOtOMk
+	eO6l3l46tRybg/T61A5O3F3Hopiy8jQNUFOcFH33PbQZD3A7ynAnMYE5kIzoorSzbHKYQ5HRLxjs0
+	BiOrT4T3G5VW6OtYqZs5TfQd51OwvpVEphIeIOxXMYtP+58XOZofSRI6qBeRsmOKSUTIfW40auYeL
+	wpfQVhcjMp1CaVegn5BtXomHTwMrvY2SrZxak5dSlvbDn1E/Oginvf6RkUitVB/2vwtF49pCZwTDT
+	d7BocZJw2CsSAPJgRJWqf920ub3rl7DWwPU1kKlpM+SEn3JOwqd0L7xpLeCp3DQfRgRMsc75nYrpP
+	kqawA7EQ==;
+Received: from localhost ([::1] helo=desiato.infradead.org)
+	by desiato.infradead.org with esmtp (Exim 4.94 #2 (Red Hat Linux))
+	id 1ldJBe-00CSro-RG; Sun, 02 May 2021 20:59:34 +0000
+Received: from mout-p-102.mailbox.org ([2001:67c:2050::465:102])
+ by desiato.infradead.org with esmtps (Exim 4.94 #2 (Red Hat Linux))
+ id 1ldJBa-00CSqZ-H7
+ for openwrt-devel@lists.openwrt.org; Sun, 02 May 2021 20:59:32 +0000
+Received: from smtp2.mailbox.org (smtp2.mailbox.org
+ [IPv6:2001:67c:2050:105:465:1:2:0])
+ (using TLSv1.3 with cipher TLS_AES_256_GCM_SHA384 (256/256 bits)
+ key-exchange ECDHE (P-384) server-signature RSA-PSS (4096 bits) server-digest
+ SHA256) (No client certificate requested)
+ by mout-p-102.mailbox.org (Postfix) with ESMTPS id 4FYJPk6VqRzQjmR;
+ Sun,  2 May 2021 22:59:22 +0200 (CEST)
+X-Virus-Scanned: amavisd-new at heinlein-support.de
+DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=hauke-m.de; s=MBO0001;
+ t=1619989161;
+ h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
+ to:to:cc:cc:mime-version:mime-version:
+ content-transfer-encoding:content-transfer-encoding;
+ bh=pdAPjgH+yZEXwI0Gc7PcH8R5Res7LgmPTJ6sR4DlLyA=;
+ b=mt3MDyelHuCxnGNy/geG6yT8L+a9Ko3UK9SldxUU7s4Z9B3ruH74agYMSYymH51b3bKE0e
+ QKPrWYOkCxg4sSiK7QGesFmj0cwoYKmnVwzhD5leTPAZtblgcT05trE3pRngwagzmLo6/D
+ g4RquIZWENSQQoZBiAhW3V3GNaNLGjBGCP19Myi00J+OQeVLxy0wUtJ51FFFGeeF1ttIut
+ /KNEgl9cgNLUr+aVsUi0pEBzf2Da6PxDhqLyMO20NkiLSHEtwdu/uSaR4QzF00UgW17Kzp
+ 1jhoAhEsnhOH1rUi/3aVzjZf3fbqZuG9YIWiHzNeruBrjgE01um6XMbM5VD2yg==
+Received: from smtp2.mailbox.org ([80.241.60.241])
+ by spamfilter02.heinlein-hosting.de (spamfilter02.heinlein-hosting.de
+ [80.241.56.116]) (amavisd-new, port 10030)
+ with ESMTP id V2Qp6bT-GwxA; Sun,  2 May 2021 22:59:20 +0200 (CEST)
+From: Hauke Mehrtens <hauke@hauke-m.de>
+To: openwrt-devel@lists.openwrt.org
+Cc: Hauke Mehrtens <hauke@hauke-m.de>
+Subject: [PATCH opkg] libopkg: pkg_hash: print unresolved dependencies
+Date: Sun,  2 May 2021 22:59:12 +0200
+Message-Id: <20210502205912.23753-1-hauke@hauke-m.de>
+MIME-Version: 1.0
+X-MBO-SPAM-Probability: **
+X-Rspamd-Score: 1.85 / 15.00 / 15.00
+X-Rspamd-Queue-Id: 0A60217FA
+X-Rspamd-UID: c322dc
+X-CRM114-Version: 20100106-BlameMichelson ( TRE 0.8.0 (BSD) ) MR-646709E3 
+X-CRM114-CacheID: sfid-20210502_215930_911077_80E02399 
+X-CRM114-Status: UNSURE (   9.57  )
+X-CRM114-Notice: Please train this message.
+X-Spam-Score: -0.9 (/)
+X-Spam-Report: Spam detection software,
+ running on the system "desiato.infradead.org",
+ has NOT identified this incoming email as spam.  The original
+ message has been attached to this so you can view it or label
+ similar future email.  If you have any questions, see
+ the administrator of that system for details.
+ Content preview:  When a package is not installed because it has unresolved
+ dependencies normally we get only an error message like this: *
+ pkg_hash_fetch_best_installation_candidate:
+ Packages for ltq-vdsl-app found, b [...]
+ Content analysis details:   (-0.9 points, 5.0 required)
+ pts rule name              description
+ ---- ----------------------
+ --------------------------------------------------
+ -0.7 RCVD_IN_DNSWL_LOW      RBL: Sender listed at https://www.dnswl.org/,
+ low trust [2001:67c:2050:0:0:0:465:102 listed in]
+ [list.dnswl.org]
+ -0.0 SPF_PASS               SPF: sender matches SPF record
+ 0.0 SPF_HELO_NONE          SPF: HELO does not publish an SPF Record
+ -0.1 DKIM_VALID Message has at least one valid DKIM or DK signature
+ -0.1 DKIM_VALID_AU          Message has a valid DKIM or DK signature from
+ author's domain
+ -0.1 DKIM_VALID_EF          Message has a valid DKIM or DK signature from
+ envelope-from domain
+ 0.1 DKIM_SIGNED            Message has a DKIM or DK signature,
+ not necessarily
+ valid
+X-BeenThere: openwrt-devel@lists.openwrt.org
+X-Mailman-Version: 2.1.34
+Precedence: list
+List-Id: OpenWrt Development List <openwrt-devel.lists.openwrt.org>
+List-Unsubscribe: <https://lists.openwrt.org/mailman/options/openwrt-devel>,
+ <mailto:openwrt-devel-request@lists.openwrt.org?subject=unsubscribe>
+List-Archive: <http://lists.openwrt.org/pipermail/openwrt-devel/>
+List-Post: <mailto:openwrt-devel@lists.openwrt.org>
+List-Help: <mailto:openwrt-devel-request@lists.openwrt.org?subject=help>
+List-Subscribe: <https://lists.openwrt.org/mailman/listinfo/openwrt-devel>,
+ <mailto:openwrt-devel-request@lists.openwrt.org?subject=subscribe>
+Sender: "openwrt-devel" <openwrt-devel-bounces@lists.openwrt.org>
+Errors-To: 
+ openwrt-devel-bounces+incoming=patchwork.ozlabs.org@lists.openwrt.org
+
+When a package is not installed because it has unresolved dependencies
+normally we get only an error message like this:
+ * pkg_hash_fetch_best_installation_candidate: Packages for ltq-vdsl-app found, but incompatible with the architectures configured
+ * opkg_install_cmd: Cannot install package ltq-vdsl-app.
+
+Log in addition the following error message:
+ * pkg_hash_check_unresolved: can not find dependency ltq-dsl-base for ltq-vdsl-app
+
+Signed-off-by: Hauke Mehrtens <hauke@hauke-m.de>
+---
+
+I am not sure if this would happen in normal cases too and spam the 
+error log, I only saw this in an error case.
+
+ libopkg/pkg_hash.c | 4 +++-
+ 1 file changed, 3 insertions(+), 1 deletion(-)
+
+diff --git a/libopkg/pkg_hash.c b/libopkg/pkg_hash.c
+index a07a25e..6c04ab2 100644
+--- a/libopkg/pkg_hash.c
++++ b/libopkg/pkg_hash.c
+@@ -263,8 +263,10 @@ pkg_hash_check_unresolved(pkg_t *maybe)
+ 	if (unresolved) {
+ 		res = 1;
+ 		tmp = unresolved;
+-		while (*tmp)
++		while (*tmp) {
++			opkg_msg(ERROR, "can not find dependency %s for %s\n", *tmp, maybe->name);
+ 			free(*(tmp++));
++		}
+ 		free(unresolved);
+ 	}
+ 	pkg_vec_free(depends);
