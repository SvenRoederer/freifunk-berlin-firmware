From: Sven Roederer <devel-sven@geroedel.de>
Date: Thu, 24 Oct 2019 17:46:28 +0200
Subject: tools/mkimake: fix handling of long pathnames

Current pathlength of cmd to call dtc is limited to 512 bytes. Using two 245 byte
paths for itb and the required parameters go over this limit and will be cut off.

/var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/scripts/mkits.sh -D asus_map-ac2200 -o /var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/build_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/linux-ipq40xx_generic/tmp/freifunk-berlin-dev-daily-1907-f66973b-ipq40xx-generic-asus_map-ac2200-initramfs-fit-uImage.itb.its -k /var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/build_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/linux-ipq40xx_generic/tmp/freifunk-berlin-dev-daily-1907-f66973b-ipq40xx-generic-asus_map-ac2200-initramfs-fit-uImage.itb -d /var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/build_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/linux-ipq40xx_generic/linux-4.14.149/arch/arm/boot/dts/qcom-ipq4019-map-ac2200.dtb -C lzma -a 0x80208000 -e 0x80208000 -c "config@1" -A arm -v 4.14.149
PATH=/var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/build_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/linux-ipq40xx_generic/linux-4.14.149/scripts/dtc:/var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-7.4.0_musl_eabi/bin:/var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-7.4.0_musl_eabi/bin:/var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-7.4.0_musl_eabi/bin:/var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-7.4.0_musl_eabi/bin:/var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/staging_dir/host/bin:/var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-7.4.0_musl_eabi/bin:/var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/staging_dir/host/bin:/var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/staging_dir/host/bin:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games mkimage -f /var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/build_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/linux-ipq40xx_generic/tmp/freifunk-berlin-dev-daily-1907-f66973b-ipq40xx-generic-asus_map-ac2200-initramfs-fit-uImage.itb.its /var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/build_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/linux-ipq40xx_generic/tmp/freifunk-berlin-dev-daily-1907-f66973b-ipq40xx-generic-asus_map-ac2200-initramfs-fit-uImage.itb.new
sh: 1: Syntax error: Unterminated quoted string
mkimage: Can't open /var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/build_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/linux-ipq40xx_generic/tmp/freifunk-berlin-dev-daily-1907-f66973b-ipq40xx-generic-asus_map-ac2200-initramfs-fit-uImage.itb.new.tmp: No such file or directory
make[6]: *** [/var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/build_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/linux-ipq40xx_generic/tmp/freifunk-berlin-dev-daily-1907-f66973b-ipq40xx-generic-asus_map-ac2200-initramfs-fit-uImage.itb] Error 255
/var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/scripts/mkits.sh -D asus_rt-ac58u -o /var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/build_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/linux-ipq40xx_generic/tmp/freifunk-berlin-dev-daily-1907-f66973b-ipq40xx-generic-asus_rt-ac58u-initramfs-fit-uImage.itb.its -k /var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/build_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/linux-ipq40xx_generic/tmp/freifunk-berlin-dev-daily-1907-f66973b-ipq40xx-generic-asus_rt-ac58u-initramfs-fit-uImage.itb -d /var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/build_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/linux-ipq40xx_generic/linux-4.14.149/arch/arm/boot/dts/qcom-ipq4018-rt-ac58u.dtb -C lzma -a 0x80208000 -e 0x80208000 -c "config@1" -A arm -v 4.14.149
PATH=/var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/build_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/linux-ipq40xx_generic/linux-4.14.149/scripts/dtc:/var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-7.4.0_musl_eabi/bin:/var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-7.4.0_musl_eabi/bin:/var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-7.4.0_musl_eabi/bin:/var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-7.4.0_musl_eabi/bin:/var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/staging_dir/host/bin:/var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/staging_dir/toolchain-arm_cortex-a7+neon-vfpv4_gcc-7.4.0_musl_eabi/bin:/var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/staging_dir/host/bin:/var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/staging_dir/host/bin:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games mkimage -f /var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/build_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/linux-ipq40xx_generic/tmp/freifunk-berlin-dev-daily-1907-f66973b-ipq40xx-generic-asus_rt-ac58u-initramfs-fit-uImage.itb.its /var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/build_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/linux-ipq40xx_generic/tmp/freifunk-berlin-dev-daily-1907-f66973b-ipq40xx-generic-asus_rt-ac58u-initramfs-fit-uImage.itb.new
sh: 1: Syntax error: Unterminated quoted string
mkimage: Can't open /var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/build_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/linux-ipq40xx_generic/tmp/freifunk-berlin-dev-daily-1907-f66973b-ipq40xx-generic-asus_rt-ac58u-initramfs-fit-uImage.itb.new.tmp: No such file or directory
make[6]: *** [/var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/build_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/linux-ipq40xx_generic/tmp/freifunk-berlin-dev-daily-1907-f66973b-ipq40xx-generic-asus_rt-ac58u-initramfs-fit-uImage.itb] Error 255
make[6]: Leaving directory `/var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/target/linux/ipq40xx/image'
make[5]: *** [install] Error 2
make[5]: Leaving directory `/var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/target/linux/ipq40xx'
make[4]: *** [install] Error 2
make[4]: Leaving directory `/var/lib/buildbot/slaves/slave/ipq40xx-generic/build/firmware/openwrt/target/linux'

diff --git a/tools/mkimage/patches/110-fix-handling-of-long-pathnames.patch b/tools/mkimage/patches/110-fix-handling-of-long-pathnames.patch
new file mode 100644
index 0000000000000000000000000000000000000000..6f568858f5f7b854df8adfe765d291cd48448756
--- /dev/null
+++ b/tools/mkimage/patches/110-fix-handling-of-long-pathnames.patch
@@ -0,0 +1,74 @@
+From d7ed7b8f24ad970d2515a68d05dabfd6c1c51cee Mon Sep 17 00:00:00 2001
+From: Sven Roederer <devel-sven@geroedel.de>
+Date: Thu, 24 Oct 2019 16:29:05 +0200
+Subject: [PATCH 1/2] tools/mkimage: fix handling long filenames
+
+The cmdline for calling the dtc was cut-off when using long filenames (e.g.
+245 bytes) for output-file and datafile of "-f" parameter.
+For FIT-images cmd[MKIMAGE_MAX_DTC_CMDLINE_LEN] is declared (hardcoded 512 bytes),
+and contains some static values, the path of a tmpfile and a datafile. tmpfile is
+max MKIMAGE_MAX_TMPFILE_LEN (256) and datafile might be also this size. Having two
+very long pathname results in a truncation os the executed shell command, as the
+truncated datafile path will not be found.
+Redefine MKIMAGE_MAX_DTC_CMDLINE_LEN to "2 * MKIMAGE_MAX_TMPFILE_LEN + 35 for the
+parameters.
+This likely applies to the "-d" parameter, too.
+
+Signed-off-by: Sven Roederer <devel-sven@geroedel.de>
+---
+ tools/mkimage.h | 3 ++-
+ 1 file changed, 2 insertions(+), 1 deletion(-)
+
+diff --git a/tools/mkimage.h b/tools/mkimage.h
+index 0254af59fb..9eb18f4239 100644
+--- a/tools/mkimage.h
++++ b/tools/mkimage.h
+@@ -42,6 +42,7 @@ static inline ulong map_to_sysmem(void *ptr)
+ #define MKIMAGE_TMPFILE_SUFFIX		".tmp"
+ #define MKIMAGE_MAX_TMPFILE_LEN		256
+ #define MKIMAGE_DEFAULT_DTC_OPTIONS	"-I dts -O dtb -p 500"
+-#define MKIMAGE_MAX_DTC_CMDLINE_LEN	512
++#define MKIMAGE_MAX_DTC_CMDLINE_LEN	2 * MKIMAGE_MAX_TMPFILE_LEN + 35 
++/* 35 bytes for quotes, spaces, "-o", len(MKIMAGE_DEFAULT_DTC_OPTIONS), len(MKIMAGE_TMPFILE_SUFFIX) */
+ 
+ #endif /* _MKIIMAGE_H_ */
+-- 
+2.20.1
+
+
+From 3ec8cb222da62dfa785c0097cd981eee48b5baa3 Mon Sep 17 00:00:00 2001
+From: Sven Roederer <devel-sven@geroedel.de>
+Date: Thu, 24 Oct 2019 16:55:35 +0200
+Subject: [PATCH 2/2] tools/fit-image: print a warning when cmd-line for dtc
+ might be truncated
+
+Signed-off-by: Sven Roederer <devel-sven@geroedel.de>
+---
+ tools/fit_image.c | 4 ++++
+ 1 file changed, 4 insertions(+)
+
+diff --git a/tools/fit_image.c b/tools/fit_image.c
+index 4aeabbcfe9..88ff093d05 100644
+--- a/tools/fit_image.c
++++ b/tools/fit_image.c
+@@ -17,6 +17,7 @@
+ #include "fit_common.h"
+ #include "mkimage.h"
+ #include <image.h>
++#include <string.h>
+ #include <stdarg.h>
+ #include <version.h>
+ #include <u-boot/crc.h>
+@@ -744,6 +745,9 @@ static int fit_handle_file(struct image_tool_params *params)
+ 		snprintf(cmd, sizeof(cmd), "cp \"%s\" \"%s\"",
+ 			 params->imagefile, tmpfile);
+ 	}
++	if (strlen(cmd) >= MKIMAGE_MAX_DTC_CMDLINE_LEN - 1) {
++		fprintf(stderr, "WARNING: command-line for FIT creation might be truncated and will probably fail.\n");
++	}
+ 
+ 	if (*cmd && system(cmd) == -1) {
+ 		fprintf (stderr, "%s: system(%s) failed: %s\n",
+-- 
+2.20.1
+
