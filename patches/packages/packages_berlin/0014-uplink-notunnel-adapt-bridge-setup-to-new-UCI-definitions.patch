From: Sven Roederer <freifunk@it-solutions.geroedel.de>
Date: Mon, 31 May 2021 22:04:47 +0200
Subject: uplink-notunnel: adapt bridge setup to new UCI-definitions

Adapt to OpenWrts change of bridge-interfaces, soo:
https://github.com/openwrt/openwrt/commit/892fc7caa9eee9f5ef9e172677f871c02841bae8

Signed-off-by: Sven Roederer <freifunk@it-solutions.geroedel.de>

diff --git a/uplinks/freifunk-berlin-uplink-notunnel/root/etc/uci-defaults/freifunk-berlin-z95_notunnel b/uplinks/freifunk-berlin-uplink-notunnel/root/etc/uci-defaults/freifunk-berlin-z95_notunnel
index 0e6a3ef2dbd7d1905f7f7f45bd682ae4020f879e..788e73841910fedf24169789bebf5f927f192b39 100644
--- a/uplinks/freifunk-berlin-uplink-notunnel/root/etc/uci-defaults/freifunk-berlin-z95_notunnel
+++ b/uplinks/freifunk-berlin-uplink-notunnel/root/etc/uci-defaults/freifunk-berlin-z95_notunnel
@@ -42,9 +42,26 @@ uci set network.ffuplink_dev.macaddr=$macaddr
 uci commit network.ffuplink_dev
 
 # add ffuplink_dev to br-wan if not there
-ifnames=$(uci get network.wan.ifname)
-list_contains ifnames ffuplink_wan || uci set network.wan.ifname="${ifnames} ffuplink_wan"
-uci commit network.wan
+## look for our device section
+add_interface_to_bridge() {
+  local config="$1"
+  local device="$2"
+  local interface="$3"
+
+  echo "--- config: $config ---"
+  uci show network.$config
+  local thisdevice=$(uci get network.$config.name)
+  echo "  $thisdevice"
+  if [ "$device" = "$thisdevice" ]; then
+    echo "  adding interface $interface"
+    ifnames=$(uci get network.$config.ports)
+    list_contains ifnames "$interface" || uci add_list network.$config.ports=$interface
+  fi
+}
+
+config_load network
+config_foreach add_interface_to_bridge device br-wan ffuplink_wan
+uci commit network.br-wan
 
 uci set network.ffuplink.proto=dhcp
 uci set network.ffuplink.hostname=freifunk-$(echo $macaddr|tr -d :)-uplink
