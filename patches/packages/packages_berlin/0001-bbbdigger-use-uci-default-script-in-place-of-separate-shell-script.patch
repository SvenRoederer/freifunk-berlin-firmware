From: Sven Roederer <freifunk@it-solutions.geroedel.de>
Date: Tue, 10 Dec 2019 02:32:01 +0100
Subject: bbbdigger: use uci-default script in place of separate shell script

diff --git a/addons/freifunk-berlin-bbbdigger/Makefile b/addons/freifunk-berlin-bbbdigger/Makefile
index abfa7ac36658b642ef5a8aff43211d2e445a474f..4316d599d1726afbdf0990bfde1eeaabc257cef2 100644
--- a/addons/freifunk-berlin-bbbdigger/Makefile
+++ b/addons/freifunk-berlin-bbbdigger/Makefile
@@ -8,8 +8,8 @@
 include $(TOPDIR)/rules.mk
 
 PKG_NAME:=freifunk-berlin-bbbdigger
-PKG_VERSION:=0.0.3
-PKG_RELEASE:=1
+PKG_VERSION:=0.0.4
+PKG_RELEASE:=0
 
 PKG_BUILD_DIR:=$(BUILD_DIR)/$(PKG_NAME)
 
@@ -42,13 +42,8 @@ define Build/Compile
 endef
 
 define Package/freifunk-berlin-bbbdigger/install
-	$(INSTALL_DIR) $(1)/tmp
-	$(INSTALL_BIN) ./files/postinst.sh $(1)/tmp/freifunk-berlin-bbbdigger_postinst.sh
-endef
-
-define Package/freifunk-berlin-bbbdigger/postinst
-#!/bin/sh
-$${IPKG_INSTROOT}/tmp/freifunk-berlin-bbbdigger_postinst.sh
+	$(INSTALL_DIR) $(1)/etc/uci-defaults
+	$(INSTALL_BIN) ./files/etc/uci-defaults/90-freifunk-berlin-bbbdigger.sh $(1)/etc/uci-defaults/
 endef
 
 $(eval $(call BuildPackage,freifunk-berlin-bbbdigger))
diff --git a/addons/freifunk-berlin-bbbdigger/files/etc/uci-defaults/90-freifunk-berlin-bbbdigger.sh b/addons/freifunk-berlin-bbbdigger/files/etc/uci-defaults/90-freifunk-berlin-bbbdigger.sh
new file mode 100755
index 0000000000000000000000000000000000000000..da3b5e69e46ea5aa71642ef96ba06323469281b2
--- /dev/null
+++ b/addons/freifunk-berlin-bbbdigger/files/etc/uci-defaults/90-freifunk-berlin-bbbdigger.sh
@@ -0,0 +1,74 @@
+#!/bin/sh
+#
+# As part of the install, we don't want to smash an already set up config
+# but at the same time update it if necessary.  The unique attributes are:
+#
+# network.bbbdigger_dev.macaddr
+# tunneldigger.bbbdigger.uuid
+#
+# All other config sections are overwritten with current settings
+
+. /lib/functions.sh
+
+TUNNEL_SERV='a.bbb-vpn.berlin.freifunk.net:8942 b.bbb-vpn.berlin.freifunk.net:8942'
+IFACE=bbbdigger
+BIND=wan
+
+# tunneldigger UUID (and MAC) generation, if there isn't one already
+# See the website https://www.itwissen.info/MAC-Adresse-MAC-address.html
+MAC=$(uci -q get network.${IFACE}_dev.macaddr)
+if [ $? -eq 1 ]; then
+  # start with b6 for Berliner 6ackbone
+  MAC="b6"
+  for byte in 2 3 4 5 6; do
+    MAC=$MAC`dd if=/dev/urandom bs=1 count=1 2> /dev/null | hexdump -e '1/1 ":%02x"'`
+  done
+fi
+
+UUID=$(uci -q get tunneldigger.${IFACE}.uuid)
+if [ $? -eq 1 ]; then
+  UUID=$MAC
+  for byte in 7 8 9 10; do
+    UUID=$UUID`dd if=/dev/urandom bs=1 count=1 2> /dev/null | hexdump -e '1/1 ":%02x"'`
+  done
+fi
+
+# tunneldigger setup
+uci set tunneldigger.$IFACE=broker
+uci -q delete tunneldigger.$IFACE.address
+for srv in $TUNNEL_SERV; do
+  uci add_list tunneldigger.$IFACE.address=$srv
+done
+uci set tunneldigger.$IFACE.uuid=$UUID
+uci set tunneldigger.$IFACE.interface=$IFACE
+uci set tunneldigger.$IFACE.broker_selection=usage
+uci set tunneldigger.$IFACE.bind_interface=$BIND
+uci set tunneldigger.$IFACE.enabled=1
+
+# network setup
+uci set network.${IFACE}_dev=device
+uci set network.${IFACE}_dev.macaddr=$MAC
+uci set network.${IFACE}_dev.name=$IFACE
+
+uci set network.$IFACE=interface
+uci set network.$IFACE.proto=dhcp
+uci set network.$IFACE.ifname=$IFACE
+
+# firewall setup (first remove from the zone and add it back)
+ZONE=$(echo $(uci show firewall.zone_freifunk.network | cut -d \' -f 2 | sed "s/${IFACE}//g"))
+ZONE="$ZONE $IFACE"
+uci set firewall.zone_freifunk.network="${ZONE}"
+
+# olsr setup (first remove it and add it again)
+SECTION=$(uci show olsrd | grep ${IFACE} | cut -d . -f 1-2)
+[ ! -z $SECTION ] && uci delete $SECTION
+uci add olsrd Interface
+uci set olsrd.@Interface[-1].ignore=0
+uci set olsrd.@Interface[-1].interface=$IFACE
+uci set olsrd.@Interface[-1].Mode=ether
+
+#uci changes
+
+uci commit
+reload_config
+/etc/init.d/tunneldigger restart
diff --git a/addons/freifunk-berlin-bbbdigger/files/postinst.sh b/addons/freifunk-berlin-bbbdigger/files/postinst.sh
deleted file mode 100755
index da3b5e69e46ea5aa71642ef96ba06323469281b2..0000000000000000000000000000000000000000
--- a/addons/freifunk-berlin-bbbdigger/files/postinst.sh
+++ /dev/null
@@ -1,74 +0,0 @@
-#!/bin/sh
-#
-# As part of the install, we don't want to smash an already set up config
-# but at the same time update it if necessary.  The unique attributes are:
-#
-# network.bbbdigger_dev.macaddr
-# tunneldigger.bbbdigger.uuid
-#
-# All other config sections are overwritten with current settings
-
-. /lib/functions.sh
-
-TUNNEL_SERV='a.bbb-vpn.berlin.freifunk.net:8942 b.bbb-vpn.berlin.freifunk.net:8942'
-IFACE=bbbdigger
-BIND=wan
-
-# tunneldigger UUID (and MAC) generation, if there isn't one already
-# See the website https://www.itwissen.info/MAC-Adresse-MAC-address.html
-MAC=$(uci -q get network.${IFACE}_dev.macaddr)
-if [ $? -eq 1 ]; then
-  # start with b6 for Berliner 6ackbone
-  MAC="b6"
-  for byte in 2 3 4 5 6; do
-    MAC=$MAC`dd if=/dev/urandom bs=1 count=1 2> /dev/null | hexdump -e '1/1 ":%02x"'`
-  done
-fi
-
-UUID=$(uci -q get tunneldigger.${IFACE}.uuid)
-if [ $? -eq 1 ]; then
-  UUID=$MAC
-  for byte in 7 8 9 10; do
-    UUID=$UUID`dd if=/dev/urandom bs=1 count=1 2> /dev/null | hexdump -e '1/1 ":%02x"'`
-  done
-fi
-
-# tunneldigger setup
-uci set tunneldigger.$IFACE=broker
-uci -q delete tunneldigger.$IFACE.address
-for srv in $TUNNEL_SERV; do
-  uci add_list tunneldigger.$IFACE.address=$srv
-done
-uci set tunneldigger.$IFACE.uuid=$UUID
-uci set tunneldigger.$IFACE.interface=$IFACE
-uci set tunneldigger.$IFACE.broker_selection=usage
-uci set tunneldigger.$IFACE.bind_interface=$BIND
-uci set tunneldigger.$IFACE.enabled=1
-
-# network setup
-uci set network.${IFACE}_dev=device
-uci set network.${IFACE}_dev.macaddr=$MAC
-uci set network.${IFACE}_dev.name=$IFACE
-
-uci set network.$IFACE=interface
-uci set network.$IFACE.proto=dhcp
-uci set network.$IFACE.ifname=$IFACE
-
-# firewall setup (first remove from the zone and add it back)
-ZONE=$(echo $(uci show firewall.zone_freifunk.network | cut -d \' -f 2 | sed "s/${IFACE}//g"))
-ZONE="$ZONE $IFACE"
-uci set firewall.zone_freifunk.network="${ZONE}"
-
-# olsr setup (first remove it and add it again)
-SECTION=$(uci show olsrd | grep ${IFACE} | cut -d . -f 1-2)
-[ ! -z $SECTION ] && uci delete $SECTION
-uci add olsrd Interface
-uci set olsrd.@Interface[-1].ignore=0
-uci set olsrd.@Interface[-1].interface=$IFACE
-uci set olsrd.@Interface[-1].Mode=ether
-
-#uci changes
-
-uci commit
-reload_config
-/etc/init.d/tunneldigger restart
