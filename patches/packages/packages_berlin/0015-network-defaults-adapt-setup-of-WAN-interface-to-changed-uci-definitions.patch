From: Sven Roederer <freifunk@it-solutions.geroedel.de>
Date: Thu, 10 Jun 2021 01:25:31 +0200
Subject: network-defaults: adapt setup of WAN-interface to changed uci-definitions

chekc commit from Wizard

diff --git a/defaults/freifunk-berlin-network-defaults/root/etc/uci-defaults/freifunk-berlin-network-defaults b/defaults/freifunk-berlin-network-defaults/root/etc/uci-defaults/freifunk-berlin-network-defaults
index f670dca4fe16e08da264ff686a7471841c419b43..590028ef9093b1dd9782852dbcf1405339b20a99 100644
--- a/defaults/freifunk-berlin-network-defaults/root/etc/uci-defaults/freifunk-berlin-network-defaults
+++ b/defaults/freifunk-berlin-network-defaults/root/etc/uci-defaults/freifunk-berlin-network-defaults
@@ -1,8 +1,35 @@
 #!/bin/sh
 
+. /lib/functions.sh
 . /lib/functions/guard.sh
 guard "network"
 
+# find_first_section_for_name(sectionname uci-config searchname)
+find_first_section_for_name() {
+  local section=$1
+  local uciconfig=$2
+  local search=$3
+
+  if [ $(uci -q get ${uciconfig}.${section}.name) = ${search} ]; then
+    echo ${section}
+  fi
+}
+
+wan_2_bridge() {
+  local WANDEVICE=$1
+  local WANDEVICESECTION
+
+  # find current WAN-device
+  config_load network
+  WANDEVICESECTION=$(config_foreach find_first_section_for_name device network ${WANDEVICE})
+  # define WAN-device as bridge with name "br-wan"
+  uci set network.$WANDEVICESECTION.type='bridge'
+  uci set network.$WANDEVICESECTION.name='br-wan'
+  # set WAN & WAN6 interfaces to new WAN-device
+  uci set network.wan.device="br-wan"
+  uci set network.wan6.device="br-wan"
+}
+
 # change default ip to avoid collision with user's local network
 uci set network.lan.ipaddr=192.168.42.1
 
@@ -11,8 +38,11 @@ uci set network.lan.ipaddr=192.168.42.1
 uci set network.wan.peerdns=0
 uci set network.wan6.peerdns=0
 
-# setup wan as bridge
-uci set network.wan.type=bridge
+# setup wan as bridge if it exists (e.g. 1-port devices)
+if [ -n $(uci -q get network.wan) ]; then
+#  echo >&2 "wan interface found"
+  wan_2_bridge $(uci get network.wan.device)
+fi
 
 # add tunl0 interface - tunl0 is the ipip tunnel interface for the olsr
 # SmartGateway plugin
