From: Sven Roederer <devel-sven@geroedel.de>
Date: Sun, 27 Sep 2020 02:34:02 +0200
Subject: Revert "gpsd: update to 3.21"

This reverts commit d916233928043b76e39d6ba41187bf6230fdf4d0 as it's assumed
to break build of olsrd.

diff --git a/utils/gpsd/Makefile b/utils/gpsd/Makefile
index 53428613c0bfa1b9d0bcd4e14a378f306fa06886..086b1fcdf8852beec5e9e00439425ee1c912ff1e 100644
--- a/utils/gpsd/Makefile
+++ b/utils/gpsd/Makefile
@@ -8,12 +8,12 @@
 include $(TOPDIR)/rules.mk
 
 PKG_NAME:=gpsd
-PKG_VERSION:=3.21
+PKG_VERSION:=3.20
 PKG_RELEASE:=1
 
 PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION).tar.xz
 PKG_SOURCE_URL:=@SAVANNAH/$(PKG_NAME)
-PKG_HASH:=5512a7d3c2e86be83c5555652e5b4cc9049e8878a4320be7f039eb1a7203e5f0
+PKG_HASH:=3998a5cbb728e97f896f46c3c83301b1e6c5d859393e58c2fad8c5426774d571
 
 PKG_MAINTAINER:=Pushpal Sidhu <psidhu.devel@gmail.com>
 PKG_LICENSE:=BSD-3-Clause
diff --git a/utils/gpsd/patches/0001-no-distutils-import.patch b/utils/gpsd/patches/0001-no-distutils-import.patch
index 61b3d6ea3760d34db194a651fac2e67f3053b98f..c9f7b38f6b6abb18b62b4c403965dbc90fe92926 100644
--- a/utils/gpsd/patches/0001-no-distutils-import.patch
+++ b/utils/gpsd/patches/0001-no-distutils-import.patch
@@ -8,12 +8,19 @@
  import SCons
  
  
-@@ -303,7 +302,7 @@ EnsureSConsVersion(2, 3, 0)
- EnsurePythonVersion(2, 6)
+@@ -669,6 +668,7 @@ def GetPythonValue(context, name, imp, e
+     context.Message('Obtaining Python %s... ' % name)
+     context.sconf.cached = 0  # Avoid bogus "(cached)"
+     if not env['target_python']:
++        from distutils import sysconfig
+         status, value = 0, str(eval(expr))
+     else:
+         command = [target_python_path, '-c', '%s; print(%s)' % (imp, expr)]
+@@ -1218,6 +1218,7 @@ if helping:
  
- 
--PYTHON_SYSCONFIG_IMPORT = 'from distutils import sysconfig'
-+PYTHON_SYSCONFIG_IMPORT = ''
- 
- # Utility productions
+     # If helping just get usable config info from the local Python
+     target_python_path = ''
++    from distutils import sysconfig
+     py_config_text = str(eval(PYTHON_CONFIG_CALL))
+     python_libdir = str(eval(PYTHON_LIBDIR_CALL))
  
diff --git a/utils/gpsd/patches/0002-ncurses6_detection.patch b/utils/gpsd/patches/0002-ncurses6_detection.patch
index da8c8177652730ba5cb0ac845db68611586455d1..a4c0192d557000865aa344370d6552f3a3668d94 100644
--- a/utils/gpsd/patches/0002-ncurses6_detection.patch
+++ b/utils/gpsd/patches/0002-ncurses6_detection.patch
@@ -1,6 +1,6 @@
 --- a/SConstruct
 +++ b/SConstruct
-@@ -1068,6 +1068,10 @@ else:
+@@ -874,6 +874,10 @@ else:
                  ncurseslibs += pkg_config('tinfo', rpath_hack=True)
          # It's not yet known whether rpath_hack is appropriate for
          # ncurses5-config.
diff --git a/utils/gpsd/patches/0003-no-sizeof_time_t-check.patch b/utils/gpsd/patches/0003-no-sizeof_time_t-check.patch
new file mode 100644
index 0000000000000000000000000000000000000000..fcc65d06197bae8fd701a7b0f21c96b8dfe22aeb
--- /dev/null
+++ b/utils/gpsd/patches/0003-no-sizeof_time_t-check.patch
@@ -0,0 +1,15 @@
+--- a/SConstruct
++++ b/SConstruct
+@@ -1047,12 +1047,6 @@ else:
+             confdefs.append("/* #undef HAVE_%s_H */\n"
+                             % hdr.replace("/", "_").upper())
+ 
+-    sizeof_time_t = config.CheckSizeOf("time_t")
+-    confdefs.append("#define SIZEOF_TIME_T %s\n" % sizeof_time_t)
+-    announce("sizeof(time_t) is %s" % sizeof_time_t)
+-    if 4 >= int(sizeof_time_t):
+-        announce("WARNING: time_t is too small.  It will fail in 2038")
+-
+     # check function after libraries, because some function require libraries
+     # for example clock_gettime() require librt on Linux glibc < 2.17
+     for f in ("cfmakeraw", "clock_gettime", "daemon", "fcntl", "fork",
diff --git a/utils/gpsd/test.sh b/utils/gpsd/test.sh
deleted file mode 100644
index 0ebca139206380a6ec87704d15f6b9d71f504755..0000000000000000000000000000000000000000
--- a/utils/gpsd/test.sh
+++ /dev/null
@@ -1,10 +0,0 @@
-#!/bin/sh
-
-case "$1" in
-	"gpsd")
-		gpsd -V 2>&1 | grep "$2"
-		;;
-	"gpsd-clients")
-		cgps -V 2>&1 | grep "$2"
-		;;
-esac
